<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>HHSGC — Scorecard — Fix10 (headers+widths+name align)</title>
<style>
  :root{--grid:#e5e7eb;--ink:#111827;--muted:#f3f4f6;--disabled:#f8fafc;--rowH:64px}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
  .wrap{display:flex;gap:10px;flex-direction:column;padding:8px}
  .panel{border:2px solid #e5e7eb;border-radius:12px;padding:10px}
  .card{border:2px solid #e5e7eb;border-radius:12px;padding:8px}
  .row{display:flex;gap:8px;align-items:center}
  input.sc{padding:0 3px;height:calc(var(--rowH)/2);line-height:calc(var(--rowH)/2);font-size:18px;border:0;width:100%;text-align:center;font-weight:900}
  input.pt{padding:0 3px;height:calc(var(--rowH)/2);line-height:calc(var(--rowH)/2);font-size:16px;border:0;border-top:1px dashed #e5e7eb;width:100%;text-align:center;font-weight:900}
  th{padding:0 4px;height:var(--rowH);font-size:14px;white-space:nowrap;vertical-align:middle}
  .grid{overflow:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth; max-width:100vw; padding-right:0; overscroll-behavior:contain;}
  .btn{padding:10px 12px;border-radius:12px;border:2px solid #111;background:#111;color:#fff;cursor:pointer}
  .btn.ghost{background:transparent;color:#111}
  .asidebox{margin-top:10px;border:2px dashed var(--grid);border-radius:10px;padding:8px}
  .gdisabled{background:var(--disabled); color:#9ca3af}
  .gcell{font-size:18px;line-height:1;padding:6px 0}
  .labelcell{white-space:nowrap}
  .cellwrap{position:relative; display:grid; grid-template-rows:1fr 1fr; height:var(--rowH)}
  select.greenie{width:100%; font-weight:800; border:0; background:transparent; padding:4px 0}
  select.greenie:disabled{opacity:.6}
  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{border-right:1px solid var(--grid);border-bottom:1px solid var(--grid)}
  th:first-child,td:first-child{border-left:1px solid var(--grid)}
  thead th{position:sticky;top:0;background:#f8fafc;z-index:3}
  th{background:#eef2ff;text-align:center}
  td{padding:0;text-align:center}
  .name{position:sticky;left:0;z-index:8;background:#fff;padding:0 8px;font-weight:900;font-size:18px;min-width:150px;max-width:170px;height:var(--rowH);display:flex;align-items:center;gap:8px;justify-content:space-between}
  .name .segchip{ font-size:12px; font-weight:900; color:#374151; margin-right:auto; }
  .name .nm{ display:inline-block; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:right; }
  thead th.sticky-head{position:sticky;left:0;z-index:9;background:#eef2ff;min-width:150px;max-width:170px;font-size:16px;font-weight:900;height:var(--rowH);display:flex;align-items:center;justify-content:space-between;padding:0 8px;}
  .h1col{border-left:2px solid #d1d5db !important}
  .sum{background:#e8fff2;font-weight:900}
  .holew{min-width:60px; max-width:60px;} /* OUT/IN same width as holes */
  .seg{background:#66ccff;text-align:center;font-weight:700;font-size:14px;line-height:1.3;padding:6px 0;user-select:none;}
  .tiny{font-size:11px;color:#6b7280;font-weight:900}
  @media (max-width: 430px){ :root{ --rowH:68px } }
  @media (orientation:landscape){ .wrap{flex-direction:row} .panel{flex:0 0 360px} }
  /* Hole column widths */
  #card thead th:nth-child(n+2):nth-child(-n+19),
  #card tbody td:nth-child(n+2):nth-child(-n+19){ min-width:60px; max-width:60px; }
</style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <h2 style="margin:0 0 8px">Setup</h2>
    <label>Event</label>
    <input id="eventName" type="text" value="HHSGC — Rotating Teams 6/6/6" style="width:100%;padding:10px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
    <label>Scoring method (for hole winners)</label>
    <select id="method" style="width:100%;padding:10px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
      <option value="best">Best Ball (lowest single per team)</option>
      <option value="sum" selected>Team Total (sum all players on team)</option>
    </select>
    <label>Players & Teams by Segment</label>
    <div class="tiny" style="margin-bottom:6px">S1 = Holes 1–6 · S2 = 7–12 · S3 = 13–18</div>
    <div id="players"></div>
    <div class="row" style="margin-top:8px;flex-wrap:wrap">
      <button class="btn" id="addP">+ Add Player</button>
      <button class="btn ghost" id="clearP">Clear Scores</button>
      <button class="btn ghost" id="clearNames">Clear Names</button>
    </div>
    <div class="asidebox tiny">
      <div class="row" style="align-items:center">
        <input id="autoAlign" type="checkbox" style="width:18px;height:18px;margin-right:8px">
        <label for="autoAlign"><b>Auto‑align focused hole</b> (turn <u>off</u> on iPhone if cursor drifts)</label>
      </div>
    </div>
    <div class="asidebox tiny">
      <div style="font-weight:900;margin-bottom:6px">Rates</div>
      <div class="row">
        <label style="min-width:140px">Sixes unit ($):</label>
        <input id="rateSixes" type="number" step="0.01" value="0.25" style="flex:1;padding:8px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
      </div>
      <div class="row" style="margin-top:6px">
        <label style="min-width:140px">Greenies unit ($/dot):</label>
        <input id="rateGreenies" type="number" step="0.01" value="0.25" style="flex:1;padding:8px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
      </div>
      <div class="tiny" style="margin-top:6px">
        Segments: losers pay each winner the Sixes unit.<br>
        Greenies: winner gets <b>3×</b> unit per dot; everyone else pays <b>1×</b> per dot.
      </div>
    </div>
    <div class="asidebox tiny" id="moneySummary">
      $1 per player goes to lowest total putts (ties split). Configure segment/greenies rates above.
    </div>
    <div class="asidebox tiny">
      <div style="font-weight:900;margin-bottom:6px">Greenies</div>
      <div style="margin-bottom:6px">Dots: 1 on each par-3. If previous par-3 carried, next winner shows 2 dots; 3 dots if two straight carries, etc.</div>
      <label>Par-3 holes (comma-separated)</label>
      <input id="par3Input" type="text" value="4,8,13,16" style="width:100%;padding:8px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
    </div>
  </aside>
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div id="titleOut" style="font-size:20px;font-weight:900">HHSGC — Rotating Teams 6/6/6</div>
      <span class="tiny" style="font-weight:900">OUT/IN · Segment points · $1 Putts Pot · Greenies</span>
      <div class="row" style="gap:6px;flex-wrap:wrap">
        <button class="btn" id="dlCsv">Download CSV</button>
        <button class="btn ghost" id="dlJson">Download Snapshot (.json)</button>
      </div>
    </div>
    <div class="grid">
      <table id="card">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>
<script>
(function(){
  'use strict';
  function $(id){return document.getElementById(id);}
  function toCSVRow(cells){ return cells.map(function(x){ if(x==null) x=''; x=String(x); if(/[\",\\n]/.test(x)){x='\"'+x.replace(/\"/g,'\"\"')+'\"';} return x; }).join(','); }
  function downloadBlob(filename, mime, content){ var blob=new Blob([content],{type:mime}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url); a.remove();},0); }
  function seg(h){return Math.floor(h/6);} function dotText(n){return n>0?'•'.repeat(Math.min(4,n)):'';} function norm(s){return (s||'').trim().toLowerCase();}
  var state = {players:[{name:'',teams:['A','B','A']},{name:'',teams:['B','A','B']},{name:'',teams:['A','B','A']},{name:'',teams:['B','A','B']}],scores:{},method:'sum',puttFee:1.00,par3:[4,8,13,16],greenieWinner:Array(18).fill(''),rateSixes:0.25,rateGreenies:0.25,autoAlign:false};

  function keyFor(i){ return (state.players[i].name||('row'+i)); }
  function ensure(key){ if(!state.scores[key]) state.scores[key]={strokes:Array(18).fill(''), putts:Array(18).fill('')}; }
  function stickyWidth(){ var h=document.querySelector('thead th.sticky-head'); return h? Math.ceil(h.getBoundingClientRect().width)+10 : 160; }
  function gridEl(){ return document.querySelector('.grid'); }
  function ensureVisible(el){ try{ var grid=gridEl(); if(!grid||!el) return; var rb=el.getBoundingClientRect(), gb=grid.getBoundingClientRect(); var leftLimit=gb.left+stickyWidth(); var rightLimit=gb.right-14; if(rb.left<leftLimit){ grid.scrollLeft=Math.max(0, grid.scrollLeft-(leftLimit-rb.left)); } else if(rb.right>rightLimit){ var delta=rb.right-rightLimit; var max=grid.scrollWidth-grid.clientWidth; grid.scrollLeft=Math.min(max, grid.scrollLeft+delta); } }catch(e){} }
  function scrollToColumn(c){ try{ var grid=gridEl(); if(!grid) return; if(c<=2){ grid.scrollLeft=0; return; } var ths=document.querySelectorAll('#thead th'); var idx=1+c; if(!ths[idx]) return; var desiredLeft=stickyWidth(); var targetLeft=ths[idx].offsetLeft-desiredLeft; if(!Number.isFinite(targetLeft)) targetLeft=0; if(targetLeft<0) targetLeft=0; var max=grid.scrollWidth-grid.clientWidth; if(targetLeft>max) targetLeft=max; grid.scrollLeft=targetLeft; }catch(e){} }
  function revealInput(t){ if(!t||!state.autoAlign) return; var c=parseInt(t.dataset.c,10); if(!isNaN(c)){ setTimeout(function(){ scrollToColumn(c); ensureVisible(t); },60);} }

  function renderSidebar(){
    var host=$('players'); host.innerHTML='';
    state.players.forEach(function(p,i){
      ensure(keyFor(i));
      var row=document.createElement('div'); row.className='row'; row.style.marginBottom='6px';
      row.innerHTML=''
        + '<input type="text" placeholder="Name" value="'+(p.name||'')+'" data-i="'+i+'" class="pname" style="flex:2;padding:10px;border:2px solid #e5e7eb;border-radius:10px;font-weight:700">'
        + '<select data-i="'+i+'" data-s="0" class="pteam" style="padding:10px;border:2px solid #e5e7eb;border-radius:10px"><option '+(p.teams[0]==='A'?'selected':'')+'>A</option><option '+(p.teams[0]==='B'?'selected':'')+'>B</option></select>'
        + '<select data-i="'+i+'" data-s="1" class="pteam" style="padding:10px;border:2px solid #e5e7eb;border-radius:10px"><option '+(p.teams[1]==='A'?'selected':'')+'>A</option><option '+(p.teams[1]==='B'?'selected':'')+'>B</option></select>'
        + '<select data-i="'+i+'" data-s="2" class="pteam" style="padding:10px;border:2px solid #e5e7eb;border-radius:10px"><option '+(p.teams[2]==='A'?'selected':'')+'>A</option><option '+(p.teams[2]==='B'?'selected':'')+'>B</option></select>'
        + '<button class="btn ghost" data-del="'+i+'" style="flex:0 0 auto;padding:8px 10px">✕</button>';
      host.appendChild(row);
    });
    $('par3Input').value = state.par3.join(',');
    $('rateSixes').value = state.rateSixes.toFixed(2);
    $('rateGreenies').value = state.rateGreenies.toFixed(2);
    $('autoAlign').checked = state.autoAlign;
  }

  function playerOptionsHTML(){
    var opts=['<option value=""></option>','<option value="CARRY">Carry</option>'];
    state.players.forEach(function(p){ var nm=(p.name||'').trim(); if(nm) opts.push('<option value="'+nm+'">'+nm+'</option>'); });
    return opts.join('');
  }

  function renderTable(){
    var thead=$('thead'), tbody=$('tbody'); thead.innerHTML=''; tbody.innerHTML='';
    var trh=document.createElement('tr');
    var th0=document.createElement('th'); th0.className='sticky-head'; th0.textContent='S1/S2/S3 · Player'; trh.appendChild(th0);
    for(var h=1;h<=18;h++){
      var th=document.createElement('th');
      th.innerHTML='H'+h+'<div class="tiny">S/P</div>';
      if(h===1) th.classList.add('h1col');
      trh.appendChild(th);
      if(h===9){ var thd=document.createElement('th'); thd.className='sum holew'; thd.textContent='OUT'; trh.appendChild(thd); }
      if(h===18){ var thd2=document.createElement('th'); thd2.className='sum holew'; thd2.textContent='IN'; trh.appendChild(thd2); }
    }
    ['Pts S1','Pts S2','Pts S3','Putts','Strokes','Earnings $','Greenies Pts'].forEach(function(t){ var th=document.createElement('th'); th.textContent=t; trh.appendChild(th); });
    thead.appendChild(trh);

    state.players.forEach(function(p,i){
      ensure(keyFor(i));
      var key=keyFor(i), sc=state.scores[key];
      var tr=document.createElement('tr');
      var nameCell=document.createElement('td'); nameCell.className='name';
      var segtxt=p.teams.join('/');
      nameCell.innerHTML = '<span class="segchip">'+segtxt+'</span><span class="nm">'+(p.name||'&nbsp;')+'</span>';
      tr.appendChild(nameCell);
      var out=0, inn=0, sum=0, puttsTot=0;
      for(var h=0;h<18;h++){
        var td=document.createElement('td');
        if(h===0) td.classList.add('h1col');
        td.innerHTML='<div class="cellwrap">'
          + '<input class="sc" inputmode="numeric" maxlength="2" data-n="'+key+'" data-k="strokes" data-h="'+h+'" data-r="'+(i*2)+'" data-c="'+h+'" value="'+(sc.strokes[h])+'">'
          + '<input class="pt tiny" inputmode="numeric" maxlength="1" data-n="'+key+'" data-k="putts" data-h="'+h+'" data-r="'+(i*2+1)+'" data-c="'+h+'" value="'+(sc.putts[h])+'">'
          + '</div>';
        tr.appendChild(td);
        var v=parseFloat(sc.strokes[h]); if(!isNaN(v)){ sum+=v; if(h<9) out+=v; else inn+=v; }
        var pval=parseFloat(sc.putts[h]); if(!isNaN(pval)) puttsTot+=pval;
        if(h===8){ var c=document.createElement('td'); c.className='sum holew'; c.dataset.outFor=key; c.textContent=out||''; tr.appendChild(c); }
        if(h===17){ var c2=document.createElement('td'); c2.className='sum holew'; c2.dataset.inFor=key; c2.textContent=inn||''; tr.appendChild(c2); }
      }
      var ps1=document.createElement('td'); ps1.className='sum'; ps1.dataset.psegFor=key; ps1.dataset.seg='0'; ps1.textContent='0'; tr.appendChild(ps1);
      var ps2=document.createElement('td'); ps2.className='sum'; ps2.dataset.psegFor=key; ps2.dataset.seg='1'; ps2.textContent='0'; tr.appendChild(ps2);
      var ps3=document.createElement('td'); ps3.className='sum'; ps3.dataset.psegFor=key; ps3.dataset.seg='2'; ps3.textContent='0'; tr.appendChild(ps3);
      var ptt=document.createElement('td'); ptt.className='sum'; ptt.dataset.puttsFor=key; ptt.textContent=puttsTot||''; tr.appendChild(ptt);
      var tot=document.createElement('td'); tot.className='sum'; tot.dataset.totFor=key; tot.textContent=sum||''; tr.appendChild(tot);
      var earn=document.createElement('td'); earn.className='sum'; earn.dataset.earnFor=key; earn.textContent='0.00'; tr.appendChild(earn);
      var gp=document.createElement('td'); gp.className='sum'; gp.dataset.gpFor=key; gp.textContent='0'; tr.appendChild(gp);
      $('tbody').appendChild(tr);
    });

    // Segment results & Greenies rows
    var winRow=document.createElement('tr'); var winLab=document.createElement('td'); winLab.className='seg labelcell name'; winLab.textContent='Hole Winner'; winRow.appendChild(winLab);
    for(var h2=0;h2<18;h2++){ var tdw=document.createElement('td'); tdw.className='seg'; if(h2===0) tdw.classList.add('h1col'); tdw.id='win_'+h2; tdw.textContent='-'; winRow.appendChild(tdw); if(h2===8||h2===17){ var d=document.createElement('td'); d.className='seg holew'; d.textContent=''; winRow.appendChild(d);} }
    var tail=document.createElement('td'); tail.className='seg'; tail.colSpan=7; tail.textContent=''; winRow.appendChild(tail); $('tbody').appendChild(winRow);

    var gRow=document.createElement('tr'); var gLab=document.createElement('td'); gLab.className='seg labelcell name'; gLab.textContent='Greenies dots'; gRow.appendChild(gLab);
    for(var gh=1; gh<=18; gh++){ var td=document.createElement('td'); var isP3=state.par3.indexOf(gh)>=0; td.className='seg gcell'+(isP3?'':' gdisabled'); if(gh===1) td.classList.add('h1col'); td.dataset.h1=gh; td.id='green_'+(gh-1); td.textContent=isP3?'•':'—'; gRow.appendChild(td); if(gh===9||gh===18){ var dd=document.createElement('td'); dd.className='seg holew'; dd.textContent=''; gRow.appendChild(dd);}}
    var gtail=document.createElement('td'); gtail.className='seg'; gtail.colSpan=7; gtail.textContent=''; gRow.appendChild(gtail); $('tbody').appendChild(gRow);

    var selRow=document.createElement('tr'); var sLab=document.createElement('td'); sLab.className='seg labelcell name'; sLab.textContent='Greenies'; selRow.appendChild(sLab);
    for(var sh=1; sh<=18; sh++){ var td2=document.createElement('td'); td2.className='seg'; if(sh===1) td2.classList.add('h1col'); var isP=state.par3.indexOf(sh)>=0; if(isP){ var sel=document.createElement('select'); sel.className='greenie'; sel.dataset.h1=sh; sel.innerHTML=playerOptionsHTML(); sel.value=state.greenieWinner[sh-1]||''; td2.appendChild(sel);} else { td2.classList.add('gdisabled'); td2.textContent='—'; } selRow.appendChild(td2); if(sh===9||sh===18){ var d3=document.createElement('td'); d3.className='seg holew'; d3.textContent=''; selRow.appendChild(d3);}}
    var stail=document.createElement('td'); stail.className='seg'; stail.colSpan=7; stail.textContent=''; selRow.appendChild(stail); $('tbody').appendChild(selRow);
  }

  function holeComplete(c){ for(var i=0;i<state.players.length;i++){var key=keyFor(i),s=state.scores[key]; if((s.strokes[c]+'').trim()===''||(s.putts[c]+'').trim()==='') return false;} return true; }
  function firstMissing(c){ for(var i=0;i<state.players.length;i++){var key=keyFor(i),s=state.scores[key]; if((s.strokes[c]+'').trim()==='') return document.querySelector('input.sc[data-n=\"'+key+'\"][data-c=\"'+c+'\"]'); if((s.putts[c]+'').trim()==='') return document.querySelector('input.pt[data-n=\"'+key+'\"][data-c=\"'+c+'\"]');} return null; }
  function moveDown(r,c){ var next=document.querySelector('input[data-r=\"'+(r+1)+'\"][data-c=\"'+c+'\"]'); if(next){next.focus();next.select();return;} if(holeComplete(c)){ var adv=document.querySelector('input.sc[data-r=\"0\"][data-c=\"'+(c+1)+'\"]'); if(adv){adv.focus();adv.select();return;} } else { var miss=firstMissing(c); if(miss){miss.focus();miss.select();} }}
  function moveUp(r,c){ var prev=document.querySelector('input[data-r=\"'+(r-1)+'\"][data-c=\"'+c+'\"]'); if(prev){prev.focus();prev.select();return;} var lastR=state.players.length*2-1; var back=document.querySelector('input[data-r=\"'+lastR+'\"][data-c=\"'+(c-1)+'\"]'); if(back){back.focus();} }

  function recompute(){
    var segmentTeamWins=[{A:0,B:0},{A:0,B:0},{A:0,B:0}];
    for(var h=0;h<18;h++){
      var sg=seg(h),a=[],b=[];
      state.players.forEach(function(p,i){ var key=keyFor(i); var t=p.teams[sg]; var v=parseFloat(state.scores[key]?.strokes[h]); if(isNaN(v)) return; if(t==='A') a.push(v); else if(t==='B') b.push(v); });
      var as=null,bs=null; if(state.method==='best'){ if(a.length) as=Math.min.apply(null,a); if(b.length) bs=Math.min.apply(null,b); } else { if(a.length) as=a.reduce(function(x,c){return x+c;},0); if(b.length) bs=b.reduce(function(x,c){return x+c;},0); }
      var w=document.getElementById('win_'+h); if(as!=null && bs!=null){ if(as<bs){ if(w) w.textContent='A'; segmentTeamWins[sg].A++; } else if(bs<as){ if(w) w.textContent='B'; segmentTeamWins[sg].B++; } else { if(w) w.textContent='Tie'; } } else { if(w) w.textContent='-'; }
    }
    var puttsTotals=[];
    state.players.forEach(function(p,i){ var key=keyFor(i), sc=state.scores[key],out=0,inn=0,tot=0,pt=0; for(var h=0;h<18;h++){ var v=parseFloat(sc.strokes[h]); if(!isNaN(v)){ if(h<9) out+=v; else inn+=v; tot+=v; } var pv=parseFloat(sc.putts[h]); if(!isNaN(pv)) pt+=pv; } var oc=document.querySelector('[data-out-for=\"'+key+'\"]'); if(oc) oc.textContent=out||''; var ic=document.querySelector('[data-in-for=\"'+key+'\"]'); if(ic) ic.textContent=inn||''; var tc=document.querySelector('[data-tot-for=\"'+key+'\"]'); if(tc) tc.textContent=tot||''; var pc=document.querySelector('[data-putts-for=\"'+key+'\"]'); if(pc) pc.textContent=pt||''; puttsTotals.push({key:key,name:(p.name||key),putts:pt}); });
    puttsTotals.sort(function(a,b){return a.putts-b.putts;}); var low=puttsTotals.length?puttsTotals[0].putts:null; var winners=puttsTotals.filter(function(x){return x.putts===low;}); var pot=state.puttFee * state.players.length; var share=winners.length?(pot/winners.length):0;
    for(var s=0;s<3;s++){ var winTeam=null; if(segmentTeamWins[s].A>segmentTeamWins[s].B) winTeam='A'; else if(segmentTeamWins[s].B>segmentTeamWins[s].A) winTeam='B'; state.players.forEach(function(p,i){ var key=keyFor(i); var cell=document.querySelector('[data-pseg-for=\"'+key+'\"][data-seg=\"'+s+'\"]'); if(cell){ cell.textContent=(winTeam && p.teams[s]===winTeam) ? '1':'0'; }}); }
    var earn={}; state.players.forEach(function(p,i){ earn[keyFor(i)]=0; });
    for(var s2=0;s2<3;s2++){ var winTeam=null; if(segmentTeamWins[s2].A>segmentTeamWins[s2].B) winTeam='A'; else if(segmentTeamWins[s2].B>segmentTeamWins[s2].A) winTeam='B'; if(winTeam){ var winnersCount=state.players.filter(function(pp){return pp.teams[s2]===winTeam;}).length; var losersCount=state.players.length - winnersCount; state.players.forEach(function(p,i){ var k=keyFor(i); if(p.teams[s2]===winTeam){ earn[k]+=losersCount*state.rateSixes; } else { earn[k]-=winnersCount*state.rateSixes; } }); } }
    var greenPts={}; state.players.forEach(function(p,i){ greenPts[keyFor(i)]=0; });
    (function(){ var p3=state.par3.slice().sort(function(a,b){return a-b;}); var carry=0; for(var i=0;i<p3.length;i++){ var h1=p3[i], idx=h1-1, wname=state.greenieWinner[idx]; var dots=1+carry; var gcell=document.getElementById('green_'+idx); if(gcell){ gcell.textContent=dotText(dots); } if((wname||'') && norm(wname)!=='carry'){ var winnerKey=null; state.players.forEach(function(p,j){ if(p.name && norm(p.name)===norm(wname)){ winnerKey=keyFor(j);} }); if(winnerKey){ var plus=3*state.rateGreenies*dots; var minus=1*state.rateGreenies*dots; earn[winnerKey]+=plus; state.players.forEach(function(p,j){ var k=keyFor(j); if(k!==winnerKey){ earn[k]-=minus; } }); } carry=0; } else { carry+=1; } } })();
    (function(){ var p3=state.par3.slice().sort(function(a,b){return a-b;}); var carry=0; for(var i=0;i<p3.length;i++){ var h1=p3[i], idx=h1-1, wname=state.greenieWinner[idx]; var dots=1+carry; if((wname||'') && norm(wname)!=='carry'){ state.players.forEach(function(p,j){ if(p.name && norm(p.name)===norm(wname)){ greenPts[keyFor(j)]+=dots; } }); carry=0; } else { carry+=1; } } })();
    state.players.forEach(function(p,i){ var key=keyFor(i); var earnCell=document.querySelector('[data-earn-for=\"'+key+'\"]'); if(earnCell) earnCell.textContent=earn[key].toFixed(2); var gpCell=document.querySelector('[data-gp-for=\"'+key+'\"]'); if(gpCell) gpCell.textContent=greenPts[key]||0; });
    $('moneySummary').innerHTML = 'Putt pot: $'+pot.toFixed(2)+(winners.length?(' — winners: '+winners.map(function(w){return w.name;}).join(', ')+' @ $'+share.toFixed(2)):'')+'<br>Sixes $'+state.rateSixes.toFixed(2)+' | Greenies $'+state.rateGreenies.toFixed(2)+' (/dot)';
  }

  function hookSidebar(){
    $('players').addEventListener('input', function(e){
      if(e.target.className==='pname'){
        var i=+e.target.dataset.i, old=state.players[i].name, nv=e.target.value;
        if(!state.scores[keyFor(i)]) ensure(keyFor(i));
        state.players[i].name=nv;
        var oldKey = old||('row'+i), newKey = keyFor(i);
        if(oldKey!==newKey){ state.scores[newKey] = state.scores[oldKey] || {strokes:Array(18).fill(''), putts:Array(18).fill('')}; delete state.scores[oldKey]; }
        renderTable(); hookTable(); recompute();
      }
      if(e.target.className==='pteam'){
        var i2=+e.target.dataset.i, sg=+e.target.dataset.s; state.players[i2].teams[sg]=e.target.value; renderTable(); hookTable(); recompute();
      }
    });
    $('players').addEventListener('click', function(e){
      if(e.target.dataset.del){ var i=+e.target.dataset.del, key=keyFor(i); state.players.splice(i,1); delete state.scores[key]; renderSidebar(); renderTable(); hookTable(); recompute(); }
    });
    $('clearNames').addEventListener('click', function(){ state.players.forEach(function(p,i){ var key=keyFor(i); delete state.scores[key]; p.name=''; ensure(keyFor(i)); }); renderSidebar(); renderTable(); hookTable(); recompute(); });
    $('addP').addEventListener('click', function(){ state.players.push({name:'',teams:['A','B','A']}); renderSidebar(); renderTable(); hookTable(); recompute(); var first=document.querySelector('input[data-r="0"][data-c="0"]'); if(first) first.focus(); });
    $('clearP').addEventListener('click', function(){ state.players.forEach(function(p,i){ state.scores[keyFor(i)]={strokes:Array(18).fill(''), putts:Array(18).fill('')}; }); state.greenieWinner=Array(18).fill(''); renderTable(); hookTable(); recompute(); var first=document.querySelector('input[data-r="0"][data-c="0"]'); if(first) first.focus(); });
    $('method').addEventListener('change', function(){ state.method=this.value; recompute(); });
    $('eventName').addEventListener('input', function(){ $('titleOut').textContent=this.value; });
    $('par3Input').addEventListener('input', function(){ var raw=this.value.split(',').map(function(x){return parseInt(x.trim(),10)}).filter(function(n){return !isNaN(n)&&n>=1&&n<=18;}); state.par3 = raw.length? raw : []; renderTable(); hookTable(); recompute(); });
    $('rateSixes').addEventListener('input', function(){ var v=parseFloat(this.value); if(isNaN(v)||v<0) v=0; state.rateSixes=v; recompute(); });
    $('rateGreenies').addEventListener('input', function(){ var v=parseFloat(this.value); if(isNaN(v)||v<0) v=0; state.rateGreenies=v; recompute(); });
    $('autoAlign').addEventListener('change', function(){ state.autoAlign=this.checked; });
  }

  function hookTable(){
    var tbody=$('tbody');
    tbody.addEventListener('focusin', function(e){ if(e.target.tagName==='INPUT'){ e.target.select(); } });
    tbody.addEventListener('click', function(e){
      var cell = e.target.closest('td'); if(!cell) return;
      var strokes = cell.querySelector('input.sc');
      if(strokes && e.target !== strokes && e.target.tagName!=='INPUT' && e.target.tagName!=='SELECT'){
        strokes.focus(); strokes.select();
      }
    });
    tbody.addEventListener('keydown', function(e){
      var t=e.target; if(t.tagName!=='INPUT') return; var r=+t.dataset.r, c=+t.dataset.c; var key=e.key;
      var goto=function(sel){ var el=document.querySelector(sel); if(el){ el.focus(); el.select(); } };
      if(key==='ArrowRight'){ e.preventDefault(); goto('input.sc[data-r="0"][data-c="'+(c+1)+'"]'); return; }
      if(key==='ArrowLeft'){ e.preventDefault(); goto('input.sc[data-r="0"][data-c="'+(c-1)+'"]'); return; }
      if(key==='Enter' || key==='NumpadEnter' || key==='ArrowDown' || (key==='Tab' && !e.shiftKey)){ e.preventDefault(); moveDown(r,c); return; }
      if(key==='ArrowUp' || (key==='Tab' && e.shiftKey)){ e.preventDefault(); moveUp(r,c); return; }
    });
    var advTimer=null;
    tbody.addEventListener('input', function(e){
      var t=e.target; if(t.tagName!=='INPUT') return; var key=t.dataset.n, k=t.dataset.k, h=+t.dataset.h;
      if(k==='strokes'){ t.value=t.value.replace(/\\D/g,'').slice(0,2); } else { t.value=t.value.replace(/\\D/g,'').slice(0,1); }
      state.scores[key][k][h]=t.value;
      if(advTimer) clearTimeout(advTimer);
      advTimer = setTimeout(function(){
        if(t.value.length>=1){ moveDown(+t.dataset.r, +t.dataset.c); }
      }, 120);
      recompute();
    });
    tbody.addEventListener('change', function(e){
      var t=e.target; if(!(t.tagName==='SELECT' && t.classList.contains('greenie'))) return;
      var h1=parseInt(t.dataset.h1,10), idx=h1-1; state.greenieWinner[idx]=t.value||''; renderTable(); hookTable(); recompute();
    });
  }

  function buildCSV(){
    var lines=[], title=$('titleOut').textContent||'HHSGC', dateStr=new Date().toLocaleString();
    lines.push(toCSVRow([title])); lines.push(toCSVRow(['Exported',dateStr])); lines.push('');
    lines.push(toCSVRow(['Scoring method', state.method]));
    lines.push(toCSVRow(['Sixes unit ($)', state.rateSixes.toFixed(2)]));
    lines.push(toCSVRow(['Greenies unit ($/dot)', state.rateGreenies.toFixed(2)]));
    lines.push(toCSVRow(['Par-3 holes', state.par3.join(' ')])); lines.push('');
    var holeHeaders=[]; for(var h=1;h<=18;h++){ holeHeaders.push('H'+h+' Strokes'); holeHeaders.push('H'+h+' Putts'); }
    var head=['Player','S1 Team','S2 Team','S3 Team'].concat(holeHeaders).concat(['OUT','IN','Strokes','Putts','Segment Pts S1','Segment Pts S2','Segment Pts S3','Greenies Pts','Earnings $']); lines.push(toCSVRow(head));
    state.players.forEach(function(p,i){ var key=keyFor(i),sc=state.scores[key]; var out=0,inn=0,tot=0,pt=0; var cells=[p.name||('row'+i), p.teams[0],p.teams[1],p.teams[2]]; for(var h=0;h<18;h++){ var s=parseFloat(sc.strokes[h]); if(!isNaN(s)){ if(h<9) out+=s; else inn+=s; tot+=s;} var pu=parseFloat(sc.putts[h]); if(!isNaN(pu)) pt+=pu; cells.push(sc.strokes[h]||''); cells.push(sc.putts[h]||''); } function getText(sel){ var el=document.querySelector(sel); return el? el.textContent:''; } var s1=getText('[data-pseg-for="'+key+'"][data-seg="0"]'); var s2=getText('[data-pseg-for="'+key+'"][data-seg="1"]'); var s3=getText('[data-pseg-for="'+key+'"][data-seg="2"]'); var gp=getText('[data-gp-for="'+key+'"]'); var earn=getText('[data-earn-for="'+key+'"]'); cells.push(out||''); cells.push(inn||''); cells.push(tot||''); cells.push(pt||''); cells.push(s1||''); cells.push(s2||''); cells.push(s3||''); cells.push(gp||''); cells.push(earn||''); lines.push(toCSVRow(cells)); });
    lines.push(''); lines.push(toCSVRow(['Greenies winners (per par-3)'])); var gwHead=['Hole'].concat(state.par3.map(function(h){return 'H'+h;})); var gwRow=['Winner'].concat(state.par3.map(function(h){return state.greenieWinner[h-1]||'';})); lines.push(toCSVRow(gwHead)); lines.push(toCSVRow(gwRow)); return lines.join('\\n');
  }

  function buildSnapshotJSON(){
    var payload={title:$('titleOut').textContent||'HHSGC',method:state.method,rateSixes:state.rateSixes,rateGreenies:state.rateGreenies,par3:state.par3,players:state.players,scores:state.scores,greenieWinner:state.greenieWinner};
    return JSON.stringify(payload,null,2);
  }

  function init(){
    renderSidebar(); renderTable(); hookSidebar(); hookTable(); recompute();
    var grid=document.querySelector('.grid'); if(grid){ grid.scrollLeft=0; }
    var first=document.querySelector('input[data-r="0"][data-c="0"]'); if(first){ first.focus(); first.select(); }
    $('dlCsv').addEventListener('click', function(){ var title=($('titleOut').textContent||'HHSGC').replace(/[^A-Za-z0-9 _-]/g,''); var csv=buildCSV(); downloadBlob(title+' — Scorecard.csv','text/csv;charset=utf-8',csv); });
    $('dlJson').addEventListener('click', function(){ var title=($('titleOut').textContent||'HHSGC').replace(/[^A-Za-z0-9 _-]/g,''); var js=buildSnapshotJSON(); downloadBlob(title+' — Snapshot.json','application/json;charset=utf-8',js); });
  }
  init();
})();
</script>
</body>
</html>
