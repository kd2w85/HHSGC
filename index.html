<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>HHSGC — Mobile Scorecard + Greenies (v9b)</title>
<style>
  :root{--grid:#e5e7eb;--ink:#111827;--muted:#f3f4f6;--disabled:#f8fafc}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
  .wrap{display:flex;gap:10px;flex-direction:column;padding:8px}
  .panel{border:2px solid #e5e7eb;border-radius:12px;padding:10px}
  .card{border:2px solid #e5e7eb;border-radius:12px;padding:8px}
  .row{display:flex;gap:8px;align-items:center}
  input.sc{padding:6px 3px;font-size:17px;border:0;width:100%;text-align:center;font-weight:900}
  input.pt{padding:5px 3px;font-size:15px;border:0;border-top:1px dashed #e5e7eb;width:100%;text-align:center;font-weight:900}
  th{padding:6px 4px;font-size:14px;white-space:nowrap}
  td .tiny{font-size:12px}
  .grid{position:relative; overflow:auto; overflow-x:auto; -webkit-overflow-scrolling:touch; max-width:100vw; padding-right:8px;}
  .btn{padding:10px 12px;border-radius:12px;border:2px solid #111;background:#111;color:#fff}
  .btn.ghost{background:transparent;color:#111}
  .badge{padding:6px 10px}
  .divider{min-width:54px}
  .asidebox{margin-top:10px;border:2px dashed var(--grid);border-radius:10px;padding:8px}
  .gdisabled{background:var(--disabled); color:#9ca3af}
  .gcell{font-size:18px;line-height:1;padding:6px 0}
  .labelcell{white-space:nowrap}
  .gmark{position:absolute; right:4px; bottom:2px; font-size:14px; line-height:1; }
  .cellwrap{position:relative; display:grid; grid-template-rows:1fr 1fr}
  select.greenie{width:100%; font-weight:800; border:0; background:transparent; padding:4px 0}
  select.greenie:disabled{opacity:.6}

  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{border-right:1px solid var(--grid);border-bottom:1px solid var(--grid)}
  th:first-child,td:first-child{border-left:1px solid var(--grid)}
  thead th{position:sticky;top:0;background:#f8fafc;z-index:3}
  th{background:#eef2ff;text-align:center}
  td{padding:0;text-align:center}

  /* Sticky name column — narrower, right-aligned names, no divider */
  .name{
    position:-webkit-sticky; position:sticky; left:0; z-index:8; background:#fff;
    padding:6px 8px;text-align:right;font-weight:900;
    font-size:18px;min-width:130px;max-width:150px;
    box-shadow: 2px 0 0 #d1d5db;
    -webkit-backface-visibility: hidden; backface-visibility: hidden;
  }
  .name .segchip{
    float:left; font-size:12px; font-weight:900; color:#374151;
  }
  .name .nm{
    display:inline-block; max-width:calc(100% - 56px);
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  thead th.sticky-head{
    position:-webkit-sticky; position:sticky; left:0; z-index:9; background:#eef2ff;
    text-align:right;min-width:130px;max-width:150px;font-size:16px;font-weight:900;
    box-shadow: 2px 0 0 #d1d5db;
    -webkit-backface-visibility: hidden; backface-visibility: hidden;
  }

  /* Scrolling divider at the left of H1 column */
  .h1col{border-left:2px solid #d1d5db !important}
  .h1col .cellwrap{padding-left:12px} /* prevent caret under sticky column on iOS */

  .sum{background:#e8fff2;font-weight:900}

  /* Summary rows: slightly shorter, smaller text, NOT bold, blue background */
  .seg{background: #66ccff; text-align:center; font-weight:700; font-size:14px; line-height:1.3; padding:6px 0; user-select:none;}

  .tiny{font-size:11px;color:#6b7280;font-weight:900}

  @media (orientation:landscape){
    .wrap{flex-direction:row}
    .panel{flex:0 0 360px}
  }

#card thead th:nth-child(n+2):nth-child(-n+19),
#card tbody td:nth-child(n+2):nth-child(-n+19){
  min-width:60px;
  max-width:60px;
}

</style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <h2 style="margin:0 0 8px">Setup</h2>
    <label>Event</label>
    <input id="eventName" type="text" value="HHSGC — Rotating Teams 6/6/6" style="width:100%;padding:10px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
    <label>Scoring method (for hole winners)</label>
    <select id="method" style="width:100%;padding:10px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
      <option value="best">Best Ball (lowest single per team)</option>
      <option value="sum" selected>Team Total (sum all players on team)</option>
    </select>

    <div class="row" style="margin-top:10px;gap:12px;align-items:flex-end">
      <div style="flex:1">
        <label>Greenie value ($)</label>
        <input id="greenieUnitInput" type="number" min="0" step="0.01" value="0.25" style="width:100%;padding:10px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
      </div>
      <div style="flex:1">
        <label>Sixes value ($)</label>
        <input id="sixesUnitInput" type="number" min="0" step="0.01" value="0.25" style="width:100%;padding:10px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
      </div>
      <button id="applyGameValues" class="btn" style="margin-left:4px">Apply</button>
    </div>


    <label>Players & Teams by Segment</label>
    <div class="tiny" style="margin-bottom:6px">S1 = Holes 1–6 · S2 = 7–12 · S3 = 13–18</div>
    <div id="players"></div>
    <div class="row" style="margin-top:8px;flex-wrap:wrap">
      <button class="btn" id="addP">+ Add Player</button>
      <button class="btn ghost" id="clearP">Clear Scores</button>
      <button class="btn ghost" id="clearNames">Clear Names</button>
    </div>

    <div class="asidebox tiny" id="moneySummary">$1 per player goes to lowest total putts (ties split). Segment bonuses: $0.25/player per winning segment.<br>Greenies: winner earns <b>points equal to dots</b> (1 by default; carries add dots). No deductions for others.</div>

    <div class="asidebox tiny">
      <div style="font-weight:900;margin-bottom:6px">Greenies</div>
      <div style="margin-bottom:6px">Dots: 1 on each par-3. If previous par-3 carried, next winner shows 2 dots; 3 dots if two straight carries, etc.</div>
      <label>Par-3 holes (comma-separated)</label>
      <input id="par3Input" type="text" value="4,8,13,16" style="width:100%;padding:8px;border:2px solid var(--grid);border-radius:10px;font-weight:700">
    </div>
  </aside>

  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div id="titleOut" style="font-size:20px;font-weight:900">HHSGC — Rotating Teams 6/6/6</div>
      <span class="badge">OUT/IN · Segment points · $1 Putts Pot · Greenies</span>
    </div>
    <div class="grid">
      <table id="card">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>

// ==== Adjustable Game Values (edit these before a round) ====
let GREENIE_UNIT = 0.25;   // per-dot unit for Greenies; winner gets 3x, others -1x per dot
let SIXES_UNIT   = 0.25;   // per-winner-per-loser unit; with 2v2 this becomes ±(2*SIXES_UNIT)
// ============================================================

  // Sync inputs with current variables on load
  document.getElementById('greenieUnitInput').value = GREENIE_UNIT.toFixed(2);
  document.getElementById('sixesUnitInput').value = SIXES_UNIT.toFixed(2);

  function applyGameValues(){
    var g = parseFloat(document.getElementById('greenieUnitInput').value);
    var s = parseFloat(document.getElementById('sixesUnitInput').value);
    if(!isFinite(g) || g < 0) g = GREENIE_UNIT;
    if(!isFinite(s) || s < 0) s = SIXES_UNIT;
    GREENIE_UNIT = g;
    SIXES_UNIT = s;
    recompute();
  }
  document.getElementById('applyGameValues').addEventListener('click', function(e){
    e.preventDefault(); applyGameValues();
  });


(function(){
  'use strict';
  var state = {players:[
      {name:"",teams:["A","B","A"]},
      {name:"",teams:["B","A","B"]},
      {name:"",teams:["A","B","A"]},
      {name:"",teams:["B","A","B"]}
    ],
    scores:{}, method:"sum", segmentBonus:0.25, puttFee:1.00,
    par3:[4,8,13,16],
    greenieWinner:Array(18).fill("")
  };
  var pending=null;
  function ensure(key){ if(!state.scores[key]) state.scores[key]={strokes:Array(18).fill(""), putts:Array(18).fill("")}; }
  function $(id){return document.getElementById(id);}
  function seg(h){return Math.floor(h/6);}
  function dotText(n){ return n>0 ? "•".repeat(Math.min(4,n)) : ""; }
function norm(s){ return (s||"").trim().toLowerCase(); }
  function keyFor(i){ return (state.players[i].name||("row"+i)); }

  /* ===== Scroll helpers to keep input visible ===== */
  function gridEl(){ return document.querySelector('.grid'); }
  function stickyWidth(){ 
    var h = document.querySelector('thead th.sticky-head'); 
    var w = h ? h.getBoundingClientRect().width : 150; 
    return w; 
  }
  function scrollToColumn(c){
    try{
      var ths = document.querySelectorAll('#thead th');
      var idx = 1 + c; // th[0] is sticky name header
      if(!ths[idx]) return;
      var grid = gridEl();
      var targetLeft = ths[idx].offsetLeft - stickyWidth() - 12;
      if(targetLeft < 0) targetLeft = 0;
      grid.scrollLeft = targetLeft;
    }catch(e){}
  }
  function revealInput(t){
    if(!t) return;
    var c = parseInt(t.dataset.c, 10);
    if(!isNaN(c)){
      setTimeout(function(){ scrollToColumn(c); }, 80);
    }
  }

  function renderSidebar(){
    var host=$("players"); host.innerHTML="";
    state.players.forEach(function(p,i){
      ensure(keyFor(i));
      var row=document.createElement("div"); row.className="row"; row.style.marginBottom="6px";
      row.innerHTML=''
        + '<input type="text" placeholder="Name" value="'+(p.name||"")+'" data-i="'+i+'" class="pname" style="flex:2;padding:10px;border:2px solid #e5e7eb;border-radius:10px;font-weight:700">'
        + '<select data-i="'+i+'" data-s="0" class="pteam" style="padding:10px;border:2px solid #e5e7eb;border-radius:10px"><option '+(p.teams[0]==="A"?"selected":"")+'>A</option><option '+(p.teams[0]==="B"?"selected":"")+'>B</option></select>'
        + '<select data-i="'+i+'" data-s="1" class="pteam" style="padding:10px;border:2px solid #e5e7eb;border-radius:10px"><option '+(p.teams[1]==="A"?"selected":"")+'>A</option><option '+(p.teams[1]==="B"?"selected":"")+'>B</option></select>'
        + '<select data-i="'+i+'" data-s="2" class="pteam" style="padding:10px;border:2px solid #e5e7eb;border-radius:10px"><option '+(p.teams[2]==="A"?"selected":"")+'>A</option><option '+(p.teams[2]==="B"?"selected":"")+'>B</option></select>'
        + '<button class="btn ghost" data-del="'+i+'" style="flex:0 0 auto;padding:8px 10px">✕</button>';
      host.appendChild(row);
    });
    $("par3Input").value = state.par3.join(",");
  }

  function playerOptionsHTML(){
    var opts = ['<option value=""></option>','<option value="CARRY">Carry</option>'];
    state.players.forEach(function(p){ var nm=(p.name||"").trim(); if(nm) opts.push('<option value="'+nm+'">'+nm+'</option>'); });
    return opts.join('');
  }

  function renderTable(){
    var thead=$("thead"), tbody=$("tbody"); thead.innerHTML=""; tbody.innerHTML="";
    var trh=document.createElement("tr");
    var th0=document.createElement("th"); th0.className="sticky-head"; th0.textContent="S1/S2/S3 · Player"; trh.appendChild(th0);
    for(var h=1;h<=18;h++){
      var th=document.createElement("th");
      th.innerHTML='H'+h+'<div class="tiny">S/P</div>';
      if(h===1) th.classList.add("h1col");
      trh.appendChild(th);
      if(h===9){ let thd=document.createElement("th"); thd.className="divider"; thd.textContent="OUT"; trh.appendChild(thd); }
      if(h===18){ let thd=document.createElement("th"); thd.className="divider"; thd.textContent="IN"; trh.appendChild(thd); }
    }
    ["Pts S1","Pts S2","Pts S3","Putts TOT","Strokes TOT","Earnings $","Greenies Pts"].forEach(function(t){ 
      var th=document.createElement("th"); th.textContent=t; trh.appendChild(th);
    });
    thead.appendChild(trh);

    state.players.forEach(function(p,i){
      ensure(keyFor(i));
      var key=keyFor(i), sc=state.scores[key];
      var tr=document.createElement("tr");
      var nameCell=document.createElement("td"); nameCell.className="name";
      var segtxt=p.teams.join('/');
      nameCell.innerHTML = '<span class="segchip">'+segtxt+'</span> <span class="nm">'+(p.name||"&nbsp;")+'</span>';
      tr.appendChild(nameCell);
      var out=0, inn=0, sum=0, puttsTot=0;
      for(var h=0;h<18;h++){
        var td=document.createElement("td");
        if(h===0) td.classList.add("h1col");
        td.innerHTML='<div class="cellwrap">'
          + '<input class="sc" inputmode="numeric" maxlength="2" data-n="'+key+'" data-k="strokes" data-h="'+h+'" data-r="'+(i*2)+'" data-c="'+h+'" value="'+(sc.strokes[h])+'">'
          + '<input class="pt tiny" inputmode="numeric" maxlength="2" data-n="'+key+'" data-k="putts" data-h="'+h+'" data-r="'+(i*2+1)+'" data-c="'+h+'" value="'+(sc.putts[h])+'">'
          + '</div>';
        if(norm(state.greenieWinner[h]) === norm(p.name) && (p.name||"").trim()!==""){
          var wrap = document.createElement("div");
          wrap.className = "gmark";
          wrap.textContent = "•";
          td.firstChild.appendChild(wrap);
        }
        tr.appendChild(td);
        var v=parseFloat(sc.strokes[h]); if(!isNaN(v)){ sum+=v; if(h<9) out+=v; else inn+=v; }
        var pval=parseFloat(sc.putts[h]); if(!isNaN(pval)) puttsTot+=pval;
        if(h===8){ let c=document.createElement("td"); c.className="sum"; c.dataset.outFor=key; c.textContent=out||""; tr.appendChild(c); }
        if(h===17){ let c=document.createElement("td"); c.className="sum"; c.dataset.inFor=key; c.textContent=inn||""; tr.appendChild(c); }
      }
      let ps1=document.createElement("td"); ps1.className="sum"; ps1.dataset.psegFor=key; ps1.dataset.seg="0"; ps1.textContent="0"; tr.appendChild(ps1);
      let ps2=document.createElement("td"); ps2.className="sum"; ps2.dataset.psegFor=key; ps2.dataset.seg="1"; ps2.textContent="0"; tr.appendChild(ps2);
      let ps3=document.createElement("td"); ps3.className="sum"; ps3.dataset.psegFor=key; ps3.dataset.seg="2"; ps3.textContent="0"; tr.appendChild(ps3);
      var ptt=document.createElement("td"); ptt.className="sum"; ptt.dataset.puttsFor=key; ptt.textContent=puttsTot||""; tr.appendChild(ptt);
      var tot=document.createElement("td"); tot.className="sum"; tot.dataset.totFor=key; tot.textContent=sum||""; tr.appendChild(tot);
      var earn=document.createElement("td"); earn.className="sum"; earn.dataset.earnFor=key; earn.textContent="0.00"; tr.appendChild(earn);
      var gp=document.createElement("td"); gp.className="sum"; gp.dataset.gpFor=key; gp.textContent="0"; tr.appendChild(gp);
      $("tbody").appendChild(tr);
    });

    // Segment / Greenies rows (shorter, smaller, blue)
    var winRow=document.createElement("tr");
    var winLab=document.createElement("td"); winLab.className="seg labelcell name"; winLab.textContent="Hole Winner"; winRow.appendChild(winLab);
    for(var h=0;h<18;h++){
      var td=document.createElement("td"); td.className="seg"; if(h===0) td.classList.add("h1col"); td.id="win_"+h; td.textContent="-"; winRow.appendChild(td);
      if(h===8){ let d=document.createElement("td"); d.className="seg"; d.textContent=""; winRow.appendChild(d); }
      if(h===17){ let d=document.createElement("td"); d.className="seg"; d.textContent=""; winRow.appendChild(d); }
    }
    var tail=document.createElement("td"); tail.className="seg"; tail.colSpan=7; tail.textContent=""; winRow.appendChild(tail);
    $("tbody").appendChild(winRow);

    var gRow=document.createElement("tr");
    var gLab=document.createElement("td"); gLab.className="seg labelcell name"; gLab.textContent="Greenies dots"; gRow.appendChild(gLab);
    for(var gh=1; gh<=18; gh++){
      var td=document.createElement("td");
      var isP3=state.par3.indexOf(gh)>=0;
      td.className="seg gcell"+(isP3?"":" gdisabled");
      if(gh===1) td.classList.add("h1col");
      td.dataset.h1 = gh;
      td.id = "green_"+(gh-1);
      td.textContent = isP3 ? "•" : "—";
      gRow.appendChild(td);
      if(gh===9){ let d=document.createElement("td"); d.className="seg"; d.textContent=""; gRow.appendChild(d); }
      if(gh===18){ let d=document.createElement("td"); d.className="seg"; d.textContent=""; gRow.appendChild(d); }
    }
    var gtail=document.createElement("td"); gtail.className="seg"; gtail.colSpan=7; gtail.textContent=""; gRow.appendChild(gtail);
    $("tbody").appendChild(gRow);

    var selRow=document.createElement("tr");
    var sLab=document.createElement("td"); sLab.className="seg labelcell name"; sLab.textContent="Greenies"; selRow.appendChild(sLab);
    for(var sh=1; sh<=18; sh++){
      var td=document.createElement("td"); td.className="seg";
      if(sh===1) td.classList.add("h1col");
      var isP3=state.par3.indexOf(sh)>=0;
      if(isP3){
        var sel=document.createElement("select");
        sel.className="greenie";
        sel.dataset.h1 = sh;
        sel.innerHTML = playerOptionsHTML();
        sel.value = state.greenieWinner[sh-1] || "";
        td.appendChild(sel);
      } else {
        td.classList.add("gdisabled");
        td.textContent = "—";
      }
      selRow.appendChild(td);
      if(sh===9){ let d=document.createElement("td"); d.className="seg"; d.textContent=""; selRow.appendChild(d); }
      if(sh===18){ let d=document.createElement("td"); d.className="seg"; d.textContent=""; selRow.appendChild(d); }
    }
    var stail=document.createElement("td"); stail.className="seg"; stail.colSpan=7; stail.textContent=""; selRow.appendChild(stail);
    $("tbody").appendChild(selRow);
  }

  function holeComplete(c){ for(var i=0;i<state.players.length;i++){var key=keyFor(i),s=state.scores[key]; if((s.strokes[c]+'').trim()===''||(s.putts[c]+'').trim()==='') return false;} return true; }
  function firstMissing(c){ for(var i=0;i<state.players.length;i++){var key=keyFor(i),s=state.scores[key]; if((s.strokes[c]+'').trim()==='') return document.querySelector('input.sc[data-n="'+key+'"][data-c="'+c+'"]'); if((s.putts[c]+'').trim()==='') return document.querySelector('input.pt[data-n="'+key+'"][data-c="'+c+'"]');} return null; }
  function moveDown(r,c){ var next=document.querySelector('input[data-r="'+(r+1)+'"][data-c="'+c+'"]'); if(next){next.focus();next.select();revealInput(next);return;} if(holeComplete(c)){ var adv=document.querySelector('input[data-r="0"][data-c="'+(c+1)+'"]'); if(adv){adv.focus();adv.select();revealInput(adv);return;} } else { var miss=firstMissing(c); if(miss){miss.focus();miss.select();revealInput(miss);} }}
  function moveUp(r,c){ var prev=document.querySelector('input[data-r="'+(r-1)+'"][data-c="'+c+'"]'); if(prev){prev.focus();prev.select();revealInput(prev);return;} var lastR=state.players.length*2-1; var back=document.querySelector('input[data-r="'+lastR+'"][data-c="'+(c-1)+'"]'); if(back){back.focus();revealInput(back);} }

  function recompute(){
    // Segment winners per hole (Sixes)
    var segmentTeamWins=[{A:0,B:0},{A:0,B:0},{A:0,B:0}];
    for(var h=0;h<18;h++){
      var sg=seg(h),a=[],b=[];
      state.players.forEach(function(p,i){
        var key=keyFor(i);
        var t=p.teams[sg]; var v=parseFloat(state.scores[key]?.strokes[h]);
        if(isNaN(v)) return; if(t==="A") a.push(v); else if(t==="B") b.push(v);
      });
      var as=null,bs=null;
      if(state.method==="best"){ if(a.length) as=Math.min.apply(null,a); if(b.length) bs=Math.min.apply(null,b); }
      else { if(a.length) as=a.reduce(function(x,c){return x+c;},0); if(b.length) bs=b.reduce(function(x,c){return x+c;},0); }
      var w=document.getElementById("win_"+h);
      if(as!=null && bs!=null){
        if(as<bs){ if(w) w.textContent="A"; segmentTeamWins[sg].A++; }
        else if(bs<as){ if(w) w.textContent="B"; segmentTeamWins[sg].B++; }
        else { if(w) w.textContent="Tie"; }
      } else { if(w) w.textContent="-"; }
    }

    // Player totals (strokes/putts)
    var puttsTotals=[];
    state.players.forEach(function(p,i){ var key=keyFor(i), sc=state.scores[key],out=0,inn=0,tot=0,pt=0;
      for(var h=0;h<18;h++){ var v=parseFloat(sc.strokes[h]); if(!isNaN(v)){ if(h<9) out+=v; else inn+=v; tot+=v; } var pv=parseFloat(sc.putts[h]); if(!isNaN(pv)) pt+=pv; }
      var oc=document.querySelector('[data-out-for="'+key+'"]'); if(oc) oc.textContent=out||"";
      var ic=document.querySelector('[data-in-for="'+key+'"]'); if(ic) ic.textContent=inn||"";
      var tc=document.querySelector('[data-tot-for="'+key+'"]'); if(tc) tc.textContent=tot||"";
      var pc=document.querySelector('[data-putts-for="'+key+'"]'); if(pc) pc.textContent=pt||"";
      puttsTotals.push({name:key,putts:pt});
    });

    // Segment bonuses ($) + set S1/S2/S3 per player
    var bonuses={}; state.players.forEach(function(p,i){bonuses[keyFor(i)]=0;});
    for(var s=0;s<3;s++){
      var winTeam = null;
      if(segmentTeamWins[s].A>segmentTeamWins[s].B) winTeam="A";
      else if(segmentTeamWins[s].B>segmentTeamWins[s].A) winTeam="B";
      state.players.forEach(function(p,i){
        var key=keyFor(i);
        var cell=document.querySelector('[data-pseg-for="'+key+'"][data-seg="'+s+'"]');
        if(cell){ cell.textContent = (winTeam && p.teams[s]===winTeam) ? "1" : "0"; }
      });
      if(winTeam){
        state.players.forEach(function(p,i){ var key=keyFor(i); if(p.teams[s]===winTeam) bonuses[key]+=state.segmentBonus; });
      }
    }
    
    // === Definitive Earnings (segments + greenies; no caps) ===
    // Segments: losers pay each winner $0.25 => winners +$0.50, losers -$0.50 (ties $0)
    // Greenies: winner +$0.75 per dot; all others -$0.25 per dot
    var earn={}; state.players.forEach(function(p,i){ earn[keyFor(i)]=0; });

    // Segment earnings across S1/S2/S3
    for(var s=0;s<3;s++){
      var winTeam = null;
      if(segmentTeamWins[s].A>segmentTeamWins[s].B) winTeam="A";
      else if(segmentTeamWins[s].B>segmentTeamWins[s].A) winTeam="B";
      if(winTeam){
        state.players.forEach(function(p,i){
          var k=keyFor(i);
          if(p.teams[s]===winTeam) earn[k] += 2 * SIXES_UNIT; else earn[k] -= 2 * SIXES_UNIT;
        });
      }
    }

    // Greenies earnings by par-3 with carries
    (function(){
      var p3 = state.par3.slice().sort(function(a,b){return a-b;});
      var carry=0;
      for(var i=0;i<p3.length;i++){
        var h1=p3[i], idx=h1-1, wname=state.greenieWinner[idx];
        var mult=1+carry;
        if((wname||"") && wname!=="CARRY"){
          var wKey=null;
          state.players.forEach(function(p,j){
            if(norm(p.name)===norm(wname)){ wKey=keyFor(j); }
          });
          if(wKey){
            earn[wKey]+=0.75*mult;
            state.players.forEach(function(p,j){
              var k=keyFor(j);
              if(k!==wKey){ earn[k]-=0.25*mult; }
            });
          }
          carry=0;
        }else{
          carry+=1;
        }
      }
    })();
    // === End earnings block ===

    
    // ---- Greenies points + dots (definitive; carries supported) ----
    var greenPts={}; state.players.forEach(function(p,i){ greenPts[keyFor(i)]=0; });
    var carryDots = {}; // holeIndex -> dots on that par-3
    (function(){
      var p3 = state.par3.slice().sort(function(a,b){return a-b;});
      var carry=0;
      for(var i=0;i<p3.length;i++){
        var h1=p3[i], idx=h1-1, wname=state.greenieWinner[idx];
        var dots = 1 + carry;
        carryDots[idx] = dots;
        var gcell = document.getElementById("green_"+idx);
        if(gcell){ gcell.textContent = dotText(dots); }

        if((wname||"") && norm(wname)!=="carry"){
          // award dots to the exact player selected
          state.players.forEach(function(p,j){
            if(p.name && norm(p.name)===norm(wname)){
              greenPts[keyFor(j)] += dots;
            }
          });
          carry = 0; // reset the carry chain on a made/won greenie
        } else {
          // no winner / carry
          carry += 1;
        }
      }
    })();

    // === Earnings ($) recompute: segments + greenies earnings using carryDots ===
    var earn={}; state.players.forEach(function(p,i){ earn[keyFor(i)]=0; });

    // Segment earnings across S1,S2,S3 (losers pay each winner $0.25)
    for(var s=0;s<3;s++){
      var winTeam = null;
      if(segmentTeamWins[s].A>segmentTeamWins[s].B) winTeam="A";
      else if(segmentTeamWins[s].B>segmentTeamWins[s].A) winTeam="B";
      if(winTeam){
        state.players.forEach(function(p,i){
          var k=keyFor(i);
          if(p.teams[s]===winTeam) earn[k] += 2 * SIXES_UNIT; else earn[k] -= 2 * SIXES_UNIT;
        });
      }
    }

    // Greenies earnings from carryDots
    (function(){
      var p3 = state.par3.slice().sort(function(a,b){return a-b;});
      for(var i=0;i<p3.length;i++){
        var h1=p3[i], idx=h1-1, wname=state.greenieWinner[idx];
        var dots = carryDots[idx] || 0;
        if((wname||"") && norm(wname)!=="carry" && dots>0){
          var winnerKey=null;
          state.players.forEach(function(p,j){
            if(p.name && norm(p.name)===norm(wname)){ winnerKey=keyFor(j); }
          });
          if(winnerKey){
            earn[winnerKey] += 3 * GREENIE_UNIT * dots;
            state.players.forEach(function(p,j){
              var k=keyFor(j);
              if(k!==winnerKey){ earn[k] -= 1 * GREENIE_UNIT * dots; }
            });
          }
        }
      }
    })();
    // Render earnings & greenies


    state.players.forEach(function(p,i){
      var key=keyFor(i);
      var earnCell=document.querySelector('[data-earn-for="'+key+'"]');
      if(earnCell) earnCell.textContent=earn[key].toFixed(2);
      var gpCell=document.querySelector('[data-gp-for="'+key+'"]');
      if(gpCell) gpCell.textContent=greenPts[key]||0;
    });

    // Sidebar summary
    var lines=[]; lines.push("Putts tracked only (no $ in earnings): $"+pot.toFixed(2)+" pot if used") ;
    if(winners.length){ lines.push("Lowest total putts: "+winners.map(function(w){return (w.name||'')+" ("+w.putts+")";}).join(", ")); lines.push("Payout: $"+share.toFixed(2)+" each"); }
    else lines.push("Lowest total putts: —");
    ["S1 (1–6)","S2 (7–12)","S3 (13–18)"].forEach(function(lbl,idx){
      var t = segmentTeamWins[idx].A>segmentTeamWins[idx].B?"A":(segmentTeamWins[idx].B>segmentTeamWins[idx].A?"B":"Tie");
      lines.push(lbl+": "+(t==="Tie"?"Tie (no bonus)":"Team "+t+" (+$"+SIXES_UNIT.toFixed(2)+" to players)"));
    });
    var gl="Greenies points: ", parts=[];
    state.players.forEach(function(p,i){ var key=keyFor(i); parts.push((p.name||"Player")+" "+(document.querySelector('[data-gp-for=\"'+key+'\"]').textContent||"0")); });
    lines.push(gl+parts.join(", "));
    $("moneySummary").innerHTML=lines.join("<br>");

    // refresh dropdowns (name changes)
    document.querySelectorAll("select.greenie").forEach(function(sel){
      var h1=parseInt(sel.dataset.h1,10), cur=sel.value;
      sel.innerHTML = playerOptionsHTML();
      sel.value = cur;
    });
  }

  function hookSidebar(){
    $("players").addEventListener("input", function(e){
      if(e.target.className==="pname"){
        var i=+e.target.dataset.i, old=state.players[i].name, nv=e.target.value;
        if(!state.scores[keyFor(i)]) ensure(keyFor(i));
        state.players[i].name=nv;
        var oldKey = old||("row"+i), newKey = keyFor(i);
        if(oldKey!==newKey){
          state.scores[newKey] = state.scores[oldKey] || {strokes:Array(18).fill(""), putts:Array(18).fill("")};
          delete state.scores[oldKey];
        }
        renderTable(); hookTable(); recompute();
      }
      if(e.target.className==="pteam"){
        var i=+e.target.dataset.i, sg=+e.target.dataset.s;
        state.players[i].teams[sg]=e.target.value; renderTable(); hookTable(); recompute();
      }
    });
    $("players").addEventListener("click", function(e){
      if(e.target.dataset.del){ var i=+e.target.dataset.del, key=keyFor(i);
        state.players.splice(i,1); delete state.scores[key];
        renderSidebar(); renderTable(); hookTable(); recompute();
      }
    });
    $("clearNames").addEventListener("click", function(){
      state.players.forEach(function(p,i){ var key=keyFor(i); delete state.scores[key]; p.name=""; ensure(keyFor(i)); });
      renderSidebar(); renderTable(); hookTable(); recompute();
    });
    $("addP").addEventListener("click", function(){
      state.players.push({name:"",teams:["A","B","A"]});
      renderSidebar(); renderTable(); hookTable(); recompute();
    });
    $("clearP").addEventListener("click", function(){
      state.players.forEach(function(p,i){ state.scores[keyFor(i)] = {strokes:Array(18).fill(""), putts:Array(18).fill("")}; });
      state.greenieWinner = Array(18).fill("");
      renderTable(); hookTable(); recompute();
      var first=document.querySelector('input[data-r="0"][data-c="0"]'); if(first) first.focus();
    });
    $("method").addEventListener("change", function(){ state.method=this.value; recompute(); });
    $("eventName").addEventListener("input", function(){ $("titleOut").textContent=this.value; });
    $("par3Input").addEventListener("input", function(){
      var raw=this.value.split(",").map(function(x){return parseInt(x.trim(),10)}).filter(function(n){return !isNaN(n)&&n>=1&&n<=18;});
      state.par3 = raw.length? raw : [];
      renderTable(); hookTable(); recompute();
    });
  }

  function hookTable(){
    var tbody=$("tbody");
    tbody.addEventListener("focusin", function(e){ if(e.target.tagName==="INPUT"){ if(pending) clearTimeout(pending); e.target.select(); revealInput(e.target); } });
    tbody.addEventListener("keydown", function(e){
      var t=e.target; if(t.tagName!=="INPUT") return; var r=+t.dataset.r, c=+t.dataset.c;
      if(pending){clearTimeout(pending); pending=null;}
      if(e.key==="Enter"||e.key==="ArrowDown"||(e.key==="Tab"&&!e.shiftKey)){ e.preventDefault(); revealInput(e.target); moveDown(r,c); }
      else if(e.key==="ArrowUp"||(e.key==="Tab"&&e.shiftKey)){ e.preventDefault(); revealInput(e.target); moveUp(r,c); }
    });
    tbody.addEventListener("input", function(e){
      var t=e.target; if(t.tagName!=="INPUT") return; var key=t.dataset.n, k=t.dataset.k, h=+t.dataset.h;
      if(k==="strokes"){ t.value=t.value.replace(/\D/g,'').slice(0,2); }
      else{ t.value=t.value.replace(/\D/g,'').slice(0,1); }
      state.scores[key][k][h]=t.value;
      if(pending) clearTimeout(pending);
      var delay=(k==="strokes")?260:100;
      pending=setTimeout(function(){
        var v=(t.value||"").trim();
        if(k==="strokes"){
          if(v==="") return;
          if(v.length===2){ if(parseInt(v,10)>10){ v="10"; t.value=v; state.scores[key][k][h]=v; } moveDown(+t.dataset.r,+t.dataset.c); }
          else{ if(v!=="1"){ moveDown(+t.dataset.r,+t.dataset.c); } }
        } else {
          if(v!==""){ moveDown(+t.dataset.r,+t.dataset.c); }
        }
        revealInput(t);
        pending=null;
      }, delay);
      recompute();
    });

    tbody.addEventListener("change", function(e){
      var t=e.target;
      if(!(t.tagName==="SELECT" && t.classList.contains("greenie"))) return;
      var h1 = parseInt(t.dataset.h1,10), idx=h1-1;
      state.greenieWinner[idx] = t.value || "";
      renderTable();
      hookTable();
      recompute();
    });
  }

  function init(){
    renderSidebar(); renderTable(); hookSidebar(); hookTable(); recompute();
    var first=document.querySelector('input[data-r="0"][data-c="0"]'); if(first) first.focus();
  }
  init();
})();
</script>
</body>
</html>
